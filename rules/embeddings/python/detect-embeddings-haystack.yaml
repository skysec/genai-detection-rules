rules:
  - id: detect-embeddings-haystack
    languages:
      - python
    severity: INFO
    message: "Detected Haystack embeddings usage: Text embeddings, document embeddings, or vector generation patterns"
    pattern-either:
      # Embedding component imports
      - pattern: from haystack.components.embedders import OpenAITextEmbedder
      - pattern: from haystack.components.embedders import OpenAIDocumentEmbedder
      - pattern: from haystack.components.embedders import $EMBEDDER
      - pattern: from haystack.components.embedders import SentenceTransformersTextEmbedder
      - pattern: from haystack.components.embedders import SentenceTransformersDocumentEmbedder
      # Embedder instantiation
      - pattern: doc_embedder = OpenAIDocumentEmbedder()
      - pattern: text_embedder = OpenAITextEmbedder()
      - pattern: $EMBEDDER = OpenAITextEmbedder(...)
      - pattern: $EMBEDDER = OpenAIDocumentEmbedder(...)
      - pattern: $VAR = SentenceTransformersTextEmbedder(...)
      # Embedding process - VERY HIGH CONFIDENCE
      - pattern: embedded_docs = doc_embedder.run(documents=$DOCS)
      - pattern: $RESULT = $EMBEDDER.run(documents=$DOCS)
      - pattern: doc_embedder.run(documents=$DOCS)
      - pattern: text_embedder.run(text=$TEXT)
      - pattern: $TEXT_EMBEDDER.run(text=$TEXT)
      - pattern: $DOC_EMBEDDER.run(documents=$DOCS)

      # Embedding retriever - VERY HIGH CONFIDENCE
      - pattern: from haystack.components.retrievers import InMemoryEmbeddingRetriever
      - pattern: retriever = InMemoryEmbeddingRetriever(document_store=$STORE)
      - pattern: $RETRIEVER = InMemoryEmbeddingRetriever(document_store=$STORE)

      # Pipeline with embedding components - HIGH CONFIDENCE
      - pattern: $PIPELINE.add_component("text_embedder", $TEXT_EMBEDDER)
      - pattern: $PIPELINE.add_component("doc_embedder", $DOC_EMBEDDER)

      # Pipeline connections for embeddings - HIGH CONFIDENCE
      - pattern: $PIPELINE.connect("text_embedder.embedding", "retriever.query_embedding")
      - pattern: $PIPELINE.connect("doc_embedder.embedding", $TARGET)
      - pattern: $PIPELINE.connect("text_embedder", "retriever")

      # Document storage with embeddings - HIGH CONFIDENCE
      - pattern: document_store.write_documents($EMBEDDED_DOCS["documents"])
      - pattern: $STORE.write_documents($EMBEDDED_DOCS["documents"])
    metadata:
      references:
        - https://docs.haystack.deepset.ai/docs/embedders
        - https://docs.haystack.deepset.ai/docs/retrievers
      category: maintainability
      technology:
        - genAI
        - LLMs
        - embeddings
        - vector-search
        - text-embeddings
        - document-embeddings
      confidence: HIGH
      subcategory:
        - embeddings