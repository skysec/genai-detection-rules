rules:
  - id: detect-memory-llamaindex
    languages:
      - python
    severity: INFO
    message: "Detected LlamaIndex memory usage: Chat memory, conversation history, or context retention patterns"
    pattern-either:
      # Memory imports
      - pattern: from llama_index.core.memory import ChatMemoryBuffer
      - pattern: from llama_index.core.memory import $MEMORY
      - pattern: from llama_index.memory import $MEMORY_TYPE
      # Memory instantiation
      - pattern: $MEMORY = ChatMemoryBuffer.from_defaults(...)
      - pattern: memory = ChatMemoryBuffer.from_defaults(token_limit=$LIMIT)
      - pattern: ChatMemoryBuffer.from_defaults(...)
      # Chat engine with memory
      - pattern: |
          $ENGINE = $INDEX.as_chat_engine(
              chat_mode=$MODE,
              memory=$MEMORY,
              ...
          )
      - pattern: $INDEX.as_chat_engine(..., memory=$MEMORY, ...)

      # LlamaIndex ChatMemoryBuffer method calls - VERY HIGH CONFIDENCE
      - pattern: |
          $MEMORY = ChatMemoryBuffer.from_defaults(...)
          ...
          $MEMORY.reset()
      - pattern: |
          $MEMORY = ChatMemoryBuffer.from_defaults(...)
          ...
          $MEMORY.get_all()
      - pattern: |
          $MEMORY = ChatMemoryBuffer.from_defaults(...)
          ...
          $MEMORY.get($KEY)
      - pattern: |
          $MEMORY = ChatMemoryBuffer.from_defaults(...)
          ...
          $MEMORY.put($KEY, $VALUE)

      # Memory buffer specific patterns - HIGH CONFIDENCE
      - pattern: ChatMemoryBuffer.from_defaults(token_limit=$LIMIT)
      - pattern: |
          $FUNC(
              ...,
              memory=$MEMORY,
              ...
          )
    metadata:
      references:
        - https://docs.llamaindex.ai/en/stable/module_guides/deploying/chat_engines/
        - https://docs.llamaindex.ai/en/stable/examples/memory/
      category: maintainability
      technology:
        - genAI
        - LLMs
        - memory
        - conversation
        - chat-history
      confidence: HIGH
      subcategory:
        - memory